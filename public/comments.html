<!DOCTYPE html>
<html lang="pt-br" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CineDisq</title>
  
  <!-- 1. Carrega o TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class', // Ativa o modo escuro
      theme: {
        extend: {
          fontFamily: {
            // Usa a fonte 'Inter' como no original, mas a UI do Disqus usa algo mais pr√≥ximo de 'Helvetica' ou 'Arial'
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            // Cores para o tema escuro, inspirado nas imagens
            'disqus-dark': {
              DEFAULT: '#1a1a1a', // Fundo principal
              'card': '#222222', // Fundo do card/form
              'border': '#333333', // Bordas
              'text-primary': '#e6e6e6', // Texto principal
              'text-secondary': '#999999', // Texto sutil
              'link': '#00b2ff' // Links (cor azul brilhante)
            }
          }
        },
      },
    }
  </script>
  
  <!-- 2. Carrega o React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- 3. Carrega o Babel (para usar JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- 4. Carrega o Firebase (Vers√£o Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

  <style>
    /* As imagens de refer√™ncia usam um tema escuro. 
      Vamos ajustar o dark mode para ser o padr√£o visual.
    */
    html {
      background-color: #f3f4f6; /* bg-gray-100 (light mode) */
      color: #111827; /* text-gray-900 (light mode) */
    }
    
    html.dark {
      background-color: #1a1a1a; /* disqus-dark */
      color: #e6e6e6; /* disqus-dark-text-primary */
    }
    
    /* Barras de rolagem customizadas para o tema escuro */
    html.dark ::-webkit-scrollbar { width: 12px; }
    html.dark ::-webkit-scrollbar-track { background: #222222; }
    html.dark ::-webkit-scrollbar-thumb {
      background-color: #4b5563; /* bg-gray-600 */
      border-radius: 20px;
      border: 3px solid #222222;
    }
    
    /* Barras de rolagem para o tema claro */
    html:not(.dark) ::-webkit-scrollbar { width: 12px; }
    html:not(.dark) ::-webkit-scrollbar-track { background: #e5e7eb; }
    html:not(.dark) ::-webkit-scrollbar-thumb {
      background-color: #9ca3af;
      border-radius: 20px;
      border: 3px solid #e5e7eb;
    }
    
    /* Efeito de hover nos √≠cones de rea√ß√£o */
    .reaction-btn:hover span {
      display: block;
    }
    
    /* Estilo para placeholder no dark mode */
    html.dark ::-webkit-input-placeholder { /* WebKit, Blink, Edge */
        color: #6b7280; /* text-gray-500 */
    }
    html.dark :-moz-placeholder { /* Mozilla Firefox 4 to 18 */
       color: #6b7280;
       opacity:  1;
    }
    html.dark ::-moz-placeholder { /* Mozilla Firefox 19+ */
       color: #6b7280;
       opacity:  1;
    }
    html.dark :-ms-input-placeholder { /* Internet Explorer 10-11 */
       color: #6b7280;
    }
    html.dark ::-ms-input-placeholder { /* Microsoft Edge */
       color: #6b7280;
    }
    html.dark ::placeholder { /* Most modern browsers */
       color: #6b7280;
    }

  </style>
</head>
<body class="h-full font-sans antialiased">
  
  <div id="root" class="h-full"></div>

  <script type="text/babel">

    // Configura√ß√£o do Firebase (Existente)
    const firebaseConfig = {
      apiKey: "AIzaSyASzMqjKOxR_KRo2JvSsBz5-2Ft3tb8Pmw",
      authDomain: "likesdocineveo.firebaseapp.com",
      databaseURL: "https://likesdocineveo-default-rtdb.firebaseio.com",
      projectId: "likesdocineveo",
      storageBucket: "likesdocineveo.firebasestorage.app",
      messagingSenderId: "797677297647",
      appId: "1:797677297647:web:b0cd29119ed2593934201a"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    const { useState, useEffect, useCallback, useMemo, memo, Fragment } = React;
    
    // --- L√≥gica do Tema ---
    const urlParams = new URLSearchParams(window.location.search);
    const theme = urlParams.get('theme');
    
    // For√ßa o dark mode se 'theme' n√£o for 'light'.
    if (theme === 'light') {
      document.documentElement.classList.remove('dark');
    } else {
      document.documentElement.classList.add('dark');
    }
    
    // --- √çcones SVG ---
    
    // √çcones sociais
    const GoogleIcon = () => (
      <svg className="w-5 h-5" viewBox="0 0 48 48">
        <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C39.712,34.426,44,28.096,44,20C44,22.659,43.862,21.35,43.611,20.083z"></path>
      </svg>
    );
    const FacebookIcon = () => (
      <svg className="w-5 h-5" viewBox="0 0 24 24" fill="#1877F2">
        <path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.494v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.294h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/>
      </svg>
    );
    const TwitterIcon = () => (
       <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
      </svg>
    );
    // √çcones de placeholder
    const CineDisqIcon = () => <span className="flex items-center justify-center w-8 h-8 bg-blue-500 text-white font-bold rounded-full text-lg">C</span>
    const MicrosoftIcon = () => (
      <svg className="w-5 h-5" viewBox="0 0 21 21" fill="none">
        <path fill="#F25022" d="M1 1h9v9H1z"/><path fill="#00A4EF" d="M1 11h9v9H1z"/><path fill="#7FBA00" d="M11 1h9v9h-9z"/><path fill="#FFB900" d="M11 11h9v9h-9z"/>
      </svg>
    );
    
    // ATUALIZADO: √çcones de Like/Dislike (Imagens)
    const LikeIcon = ({ liked }) => {
      const src = liked
        ? "https://i.ibb.co/pvdNBpjb/Gemini-Generated-Image-slk0hgslk0hgslk0-1.png"
        : "https://i.ibb.co/210x2546/Gemini-Generated-Image-uqjfysuqjfysuqjf-1.png";
      return <img src={src} alt="Like" className="w-4 h-4" />;
    };
    
    const DislikeIcon = ({ disliked }) => {
      const src = disliked
        ? "https://i.ibb.co/qF4H1Mkv/Gemini-Generated-Image-slk0hgslk0hgslk0-1.png"
        : "https://i.ibb.co/kgDvQpLX/Gemini-Generated-Image-uqjfysuqjfysuqjf-1.png";
      return <img src={src} alt="Dislike" className="w-4 h-4" />;
    };

    // √çcones de A√ß√£o (SVG restantes)
    const ReplyIcon = () => (
      <svg className="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M15 15.5a.5.5 0 0 1-.75.433L9.086 12.5H6.5A2.5 2.5 0 0 1 4 10V6.5A2.5 2.5 0 0 1 6.5 4h8A2.5 2.5 0 0 1 17 6.5V10a2.5 2.5 0 0 1-2.5 2.5h-1V15.5zM6.5 5.5A1 1 0 0 0 5.5 6.5V10a1 1 0 0 0 1 1h3.086l4.664 2.8A1.5 1.5 0 0 0 17 12.606V10a1 1 0 0 0-1-1h-1.5a.5.5 0 0 1 0-1H16a1 1 0 0 0 1-1V6.5a1 1 0 0 0-1-1h-8z" clipRule="evenodd" />
      </svg>
    );
    const FlagIcon = () => (
      <svg className="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path d="M3.5 2.75a.75.75 0 0 0-1.5 0v14.5a.75.75 0 0 0 1.5 0v-4.392l1.657-.348a6.44 6.44 0 0 1 6.372 0l.878.185A.75.75 0 0 0 13.25 12H16.5a.75.75 0 0 0 0-1.5h-3.25a.75.75 0 0 0-.707-.468l-.878-.185a4.94 4.94 0 0 0-4.91 0l-1.657.348V2.75z" />
      </svg>
    );
    const HeartIcon = () => (
      <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M3.172 5.172a4 4 0 0 1 5.656 0L10 6.343l1.172-1.171a4 4 0 1 1 5.656 5.656L10 17.657l-6.828-6.829a4 4 0 0 1 0-5.656Z" clipRule="evenodd" />
      </svg>
    );
    const ShareIcon = () => (
      <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path d="M13 4.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM8.5 6a3.5 3.5 0 1 0 3 0 3.5 3.5 0 0 0-3 0Z" />
        <path d="M13.75 9.75a.75.75 0 0 0-1.5 0v1.316a5.03 5.03 0 0 1-4.5 0V9.75a.75.75 0 0 0-1.5 0v1.5c0 .45.198.868.52 1.175l.64.615a.75.75 0 0 0 1.04-.017L10 13.107l1.19 1.134a.75.75 0 0 0 1.04.017l.64-.615c.322-.307.52-.725.52-1.175v-1.5Z" />
      </svg>
    );
    const ChevronDownIcon = () => (
      <svg className="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clipRule="evenodd" />
      </svg>
    );
    const MoreIcon = () => (
      <svg className="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 3a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM17 3a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM3 3a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3Z" />
      </svg>
    );
    // √çcone de avatar gen√©rico
    const UserCircleIcon = ({ className = "w-10 h-10" }) => (
      <svg className={`${className} text-gray-500 dark:text-gray-600`} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.5 5.5 0 0 0-5.5 5.5A.75.75 0 0 0 5.25 18h9.5a.75.75 0 0 0 .75-.75A5.5 5.5 0 0 0 10 12Z" clipRule="evenodd" />
      </svg>
    );
    // √çcone de "G" como na imagem
    const GuestIcon = () => (
      <div className="w-10 h-10 flex items-center justify-center rounded-full bg-gray-600 text-white text-xl font-semibold">
        G
      </div>
    );
    // Spinner de carregamento
    const Spinner = () => (
      <div className="w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    );
    

    // --- Hooks Customizados ---
    function usePageId() {
      const [pageId, setPageId] = useState(null);
      useEffect(() => {
        const id = urlParams.get('pageId') || 'default-page';
        setPageId(id);
      }, []);
      return pageId;
    }

    // ATUALIZADO: Hook de Autentica√ß√£o (corrigido para rea√ß√µes an√¥nimas)
    function useAuth() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(user => {
          if (user) {
            // Google, Email, ou Anonymous user encontrado
            setUser(user);
            setLoading(false);
          } else {
            // Nenhum utilizador, faz login an√¥nimo
            auth.signInAnonymously().catch(error => {
              console.error("Erro no login an√¥nimo:", error);
              setLoading(false); // Define loading como falso se o login an√¥nimo falhar
            });
            // N√£o defina o utilizador ou loading aqui; o onAuthStateChanged
            // ser√° acionado novamente com o utilizador an√¥nimo,
            // e o bloco `if (user)` tratar√° disso.
          }
        });
        return () => unsubscribe();
      }, []);
      
      const login = (providerName) => {
        let provider;
        if (providerName === 'google') {
          provider = new firebase.auth.GoogleAuthProvider();
        }
        // Adicionar outros provedores aqui
        
        if (provider) {
          auth.signInWithPopup(provider).catch(error => {
            console.error("Erro no login com Google:", error);
          });
        }
      };
      
      const logout = () => {
        auth.signOut().then(() => {
          // Ap√≥s o logout, o onAuthStateChanged ser√° acionado,
          // e o bloco 'else' far√° login an√¥nimo novamente.
        });
      };
      
      return { user, loading, login, logout };
    }
    
    function formatTimeAgo(timestamp) {
      if (!timestamp) return 'agora mesmo';
      const now = Date.now();
      const seconds = Math.floor((now - timestamp) / 1000);

      let interval = seconds / 31536000;
      if (interval > 1) return Math.floor(interval) + (Math.floor(interval) === 1 ? ' ano' : ' anos');
      interval = seconds / 2592000;
      if (interval > 1) return Math.floor(interval) + (Math.floor(interval) === 1 ? ' m√™s' : ' meses');
      interval = seconds / 86400;
      if (interval > 1) return Math.floor(interval) + (Math.floor(interval) === 1 ? ' dia' : ' dias');
      interval = seconds / 3600;
      if (interval > 1) return Math.floor(interval) + (Math.floor(interval) === 1 ? ' hora' : ' horas');
      interval = seconds / 60;
      if (interval > 1) return Math.floor(interval) + (Math.floor(interval) === 1 ? ' minuto' : ' minutos');
      
      return 'agora mesmo';
    }

    // --- Componentes React ---

    const Avatar = ({ src, alt, className = "w-10 h-10" }) => {
      const [error, setError] = useState(false);
      
      if (!src || error) {
        return (
          <div className={`${className} flex items-center justify-center rounded-full bg-gray-500 dark:bg-gray-600 text-white text-xl font-semibold`}>
            {alt ? alt.charAt(0).toUpperCase() : 'G'}
          </div>
        );
      }
      return (
        <img 
          src={src} 
          alt={alt} 
          className={`${className} rounded-full`} 
          onError={() => setError(true)} 
        />
      );
    };
    
    // ATUALIZADO: Barra de Rea√ß√µes (com bot√£o Favoritar e caminhos corrigidos)
    const ReactionsBar = ({ pageId, user }) => {
      const [reactions, setReactions] = useState({});
      const [totalResponses, setTotalResponses] = useState(0);
      const [isFavorited, setIsFavorited] = useState(false);
      
      const reactionTypes = [
        { id: 'upvote', emoji: 'üëç', label: 'Upvote' },
        { id: 'funny', emoji: 'üòÇ', label: 'Funny' },
        { id: 'love', emoji: '‚ù§Ô∏è', label: 'Love' },
        { id: 'surprised', emoji: 'üòÆ', label: 'Surprised' },
        { id: 'angry', emoji: 'üò°', label: 'Angry' },
        { id: 'sad', emoji: 'üò¢', label: 'Sad' },
      ];
      
      // *** CORRE√á√ÉO: Aponta para 'media_stats' ***
      const basePath = `media_stats/${pageId}`;
      const favRef = useMemo(() => user ? db.ref(`${basePath}/favorites/${user.uid}`) : null, [basePath, user]);
      const reactionsRef = useMemo(() => pageId ? db.ref(`${basePath}/reactions`) : null, [basePath]);
      
      // Carrega rea√ß√µes
      useEffect(() => {
        if (!reactionsRef) return;
        const listener = reactionsRef.on('value', snapshot => {
          const data = snapshot.val() || {};
          setReactions(data);
          
          const allVotes = new Set();
          Object.values(data).forEach(votes => {
            if(votes) Object.keys(votes).forEach(uid => allVotes.add(uid));
          });
          setTotalResponses(allVotes.size);
        });
        return () => reactionsRef.off('value', listener);
      }, [reactionsRef]);
      
      // Carrega status de favorito
      useEffect(() => {
        if (!favRef) {
          setIsFavorited(false);
          return;
        };
        const listener = favRef.on('value', snapshot => {
          setIsFavorited(snapshot.exists());
        });
        return () => favRef.off('value', listener);
      }, [favRef]);
      
      const handleReaction = (reactionId) => {
        if (!user || !reactionsRef) return; 
        
        // *** CORRE√á√ÉO: Aponta para 'media_stats' ***
        const ref = reactionsRef.child(`${reactionId}/${user.uid}`);
        
        ref.once('value', snapshot => {
          if (snapshot.exists()) {
            ref.remove();
          } else {
            ref.set(true);
          }
        });
      };
      
      const handleFavorite = () => {
        if (!favRef) return; // Utilizador deve estar (pelo menos) anonimamente logado
        if (isFavorited) {
          favRef.remove();
        } else {
          favRef.set(true);
        }
      };
      
      const getCount = (reactionId) => {
        return reactions[reactionId] ? Object.keys(reactions[reactionId]).length : 0;
      };
      
      const userHasReacted = (reactionId) => {
        return user && reactions[reactionId] && reactions[reactionId][user.uid];
      };

      return (
        <div className="my-6">
          {/* T√≠tulo e Bot√£o Favoritar */}
          <div className="flex flex-col sm:flex-row justify-center items-center sm:space-x-4 mb-1">
            <h4 className="font-semibold text-lg text-gray-800 dark:text-disqus-dark-text-primary">
              What do you think?
            </h4>
            <button
              onClick={handleFavorite}
              className={`flex items-center space-x-1.5 text-sm font-medium transition ${isFavorited ? 'text-blue-500' : 'text-gray-500 dark:text-disqus-dark-text-secondary hover:text-blue-500'}`}
            >
              <HeartIcon />
              <span>Favoritar esta discuss√£o</span>
            </button>
          </div>
          
          <p className="text-sm text-center text-gray-600 dark:text-disqus-dark-text-secondary mb-4">
            {totalResponses} Response{totalResponses !== 1 ? 's' : ''}
          </p>
          
          {/* Rea√ß√µes Emoji */}
          <div className="flex justify-center items-start space-x-4 md:space-x-8">
            {reactionTypes.map(reaction => (
              <div key={reaction.id} className="flex flex-col items-center">
                <button
                  onClick={() => handleReaction(reaction.id)}
                  className={`relative reaction-btn p-2 rounded-full transition duration-150 ease-in-out ${userHasReacted(reaction.id) ? 'bg-gray-200 dark:bg-gray-700' : 'hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                >
                  <span className="text-3xl">{reaction.emoji}</span>
                  <span className="hidden absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-black text-white text-xs rounded shadow-lg">
                    {reaction.label}
                  </span>
                </button>
                <span className="text-sm font-bold text-gray-800 dark:text-disqus-dark-text-primary mt-1">
                  {getCount(reaction.id)}
                </span>
              </div>
            ))}
          </div>
        </div>
      );
    };
    
    // ATUALIZADO: Formul√°rio de Login (com registo/login)
    const LoginForm = ({ login }) => {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [isExpanded, setIsExpanded] = useState(false);
      const [isLoginView, setIsLoginView] = useState(false); // true = Login, false = Register
      
      const socialButton = (provider, icon, text, onClick) => (
        <button
          onClick={onClick}
          className="flex-1 flex items-center justify-center p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition"
        >
          {icon}
        </button>
      );
      
      const disabledSocialButton = (icon) => (
         <button
          disabled
          className="flex-1 flex items-center justify-center p-2 rounded-full bg-gray-200 dark:bg-gray-700 opacity-50 cursor-not-allowed"
        >
          {icon}
        </button>
      );
      
      const handleEmailSubmit = (e) => {
        e.preventDefault();
        setError(''); // Limpa erros
        
        if (isLoginView) {
          // --- LOGIN ---
          if (!email || !password) {
            setError("Email e senha s√£o obrigat√≥rios.");
            return;
          }
          auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
              console.error("Erro ao entrar:", error);
              setError("Falha ao entrar. Verifique seu email e senha.");
            });
          
        } else {
          // --- REGISTRO ---
          if (!name || !email || !password) {
            setError("Nome, email e senha s√£o obrigat√≥rios.");
            return;
          }
          auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
              return userCredential.user.updateProfile({
                displayName: name
              });
            })
            .catch(error => {
              console.error("Erro ao registrar:", error);
              if (error.code === 'auth/email-already-in-use') {
                setError("Este email j√° est√° em uso.");
              } else {
                setError("Falha ao registrar.");
              }
            });
        }
      };

      return (
        <div className="bg-transparent dark:bg-transparent p-4 rounded-lg">
          <p className="text-xs font-bold text-gray-500 dark:text-disqus-dark-text-secondary mb-2 tracking-wide">
            FAZER LOGIN COM
          </p>
          <div className="flex space-x-2 mb-4">
            {disabledSocialButton(<CineDisqIcon />)}
            {disabledSocialButton(<FacebookIcon />)}
            {disabledSocialButton(<TwitterIcon />)}
            {socialButton('google', <GoogleIcon />, 'Google', () => login('google'))}
            {disabledSocialButton(<MicrosoftIcon />)}
          </div>
          <p className="text-xs font-bold text-gray-500 dark:text-disqus-dark-text-secondary mb-2 tracking-wide">
            OU REGISTRE-SE NO CineDisq
            <span className="ml-1 inline-flex items-center justify-center w-4 h-4 rounded-full border border-gray-500 dark:border-disqus-dark-text-secondary text-xs">?</span>
          </p>
          
          <form onSubmit={handleEmailSubmit}>
            <div className="space-y-3">
              {/* Campo de Nome (trigger) */}
              <input
                type="text"
                placeholder="Nome"
                value={name}
                onChange={(e) => setName(e.target.value)}
                onFocus={() => setIsExpanded(true)}
                className={`w-full p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-disqus-dark-border rounded-lg ... ${isExpanded && isLoginView ? 'hidden' : 'block'}`}
              />
              
              {/* Campos expandidos */}
              {isExpanded && (
                <Fragment>
                  <input
                    type="email"
                    placeholder="Email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    className="w-full p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-disqus-dark-border rounded-lg ..."
                  />
                  <input
                    type="password"
                    placeholder="Senha"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                    className="w-full p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-disqus-dark-border rounded-lg ..."
                  />
                  
                  {error && (
                    <p className="text-xs text-red-500">{error}</p>
                  )}
                  
                  {/* Bot√µes de A√ß√£o */}
                  <div className="flex items-center justify-between pt-2">
                    <button
                      type="submit"
                      className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                    >
                      {isLoginView ? 'Entrar' : 'Registrar'}
                    </button>
                    
                    <button
                      type="button"
                      onClick={() => setIsLoginView(!isLoginView)}
                      className="text-xs font-medium text-blue-500 hover:underline"
                    >
                      {isLoginView ? 'N√£o tem conta? Registrar' : 'J√° tem conta? Entrar'}
                    </button>
                  </div>
                </Fragment>
              )}
            </div>
          </form>
          
        </div>
      );
    };

    // ATUALIZADO: Formul√°rio de Coment√°rio (com anima√ß√£o de expans√£o)
    const CommentForm = memo(({ user, pageId, parentId = null, onCommentPosted }) => {
      const [text, setText] = useState('');
      const [isExpanded, setIsExpanded] = useState(!!parentId); // True para respostas, false para novo coment√°rio

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!text.trim() || !user || user.isAnonymous) return;

        const commentData = {
          text: text.trim(),
          author: user.displayName,
          authorId: user.uid,
          authorPhoto: user.photoURL,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          likes: {},
          dislikes: {},
          reports: {}
        };

        let commentsRef;
        if (parentId) {
          commentsRef = db.ref(`comments/${pageId}/${parentId}/replies`);
        } else {
          commentsRef = db.ref(`comments/${pageId}`);
        }
        
        commentsRef.push(commentData)
          .then(() => {
            setText('');
            if (parentId) {
              if(onCommentPosted) onCommentPosted(); // Fecha form de resposta
            } else {
              setIsExpanded(false); // Encolhe form principal
            }
          })
          .catch(error => console.error("Erro ao postar:", error));
      };
      
      const placeholderText = parentId ? "Adicionar uma resposta..." : "Iniciar uma discuss√£o...";

      return (
        <form onSubmit={handleSubmit} className={`w-full ${parentId ? 'mt-2' : ''}`}>
          <div className="flex items-start space-x-3">
            <Avatar src={user?.photoURL} alt={user?.displayName} />
            <div className="flex-1">
              <div className="relative">
                <textarea
                  className={`w-full p-3 bg-gray-100 dark:bg-disqus-dark-card border border-gray-300 dark:border-disqus-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-transparent dark:focus:border-blue-500 focus:border-blue-500 transition-all duration-200 ease-in-out ${isExpanded ? 'h-28' : 'h-12'} ${!parentId && isExpanded ? 'pr-24' : 'pr-3'}`}
                  placeholder={placeholderText}
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  onFocus={() => setIsExpanded(true)}
                />
                
                {/* Bot√£o para Coment√°rio Principal (dentro da caixa) */}
                {!parentId && isExpanded && (
                  <button
                    type="submit"
                    disabled={!text.trim()}
                    className="absolute bottom-3 right-3 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                  >
                    Comentar
                  </button>
                )}
              </div>
              
              {/* Bot√µes para Resposta (fora da caixa) */}
              {parentId && (
                <div className="flex justify-end space-x-2 mt-2">
                  <button
                    type="button"
                    onClick={() => {
                      if(onCommentPosted) onCommentPosted(); // Cancela
                    }}
                    className="px-4 py-2 text-sm font-medium text-gray-700 dark:text-disqus-dark-text-secondary bg-transparent hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition"
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    disabled={!text.trim()}
                    className="flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                  >
                    Responder
                  </button>
                </div>
              )}

              {/* Bot√£o Cancelar para Coment√°rio Principal (fora da caixa) */}
              {!parentId && isExpanded && (
                 <button
                    type="button"
                    onClick={() => {
                      setIsExpanded(false);
                      setText('');
                    }}
                    className="mt-2 px-3 py-1 text-xs font-medium text-gray-700 dark:text-disqus-dark-text-secondary bg-gray-200 dark:bg-gray-700 rounded-lg"
                  >
                    Cancelar
                  </button>
              )}
            </div>
          </div>
        </form>
      );
    });
    
    // Formul√°rio deslogado (an√¥nimo)
    const LoggedOutCommentForm = () => {
      const [isFocused, setIsFocused] = useState(false);
      
      return (
         <div className="flex items-start space-x-3">
            <GuestIcon />
            <div className="flex-1">
              <textarea
                className={`w-full p-3 bg-gray-100 dark:bg-disqus-dark-card border border-gray-300 dark:border-disqus-dark-border rounded-lg focus:outline-none transition-all duration-200 ease-in-out ${isFocused ? 'h-28' : 'h-12'}`}
                placeholder="Iniciar uma discuss√£o..."
                onFocus={() => setIsFocused(true)}
                onBlur={() => setIsFocused(false)}
                // Leia, mas n√£o desabilitado para permitir foco
                readOnly 
              />
              <p className={`text-xs text-gray-500 dark:text-disqus-dark-text-secondary mt-1 ${isFocused ? 'block' : 'hidden'}`}>
                Fa√ßa login para comentar.
              </p>
            </div>
          </div>
      );
    };

    // ATUALIZADO: Componente de Coment√°rio (com √≠cones de imagem)
    // NENHUMA MUDAN√áA NECESS√ÅRIA AQUI - J√Å USA A REGRA "comments" QUE EST√Å CORRETA
    const Comment = memo(({ comment, user, pageId, parentId = null }) => {
      const [showReplyForm, setShowReplyForm] = useState(false);
      const [showMenu, setShowMenu] = useState(false);
      
      const commentId = comment.id;
      const isAuthor = user && user.uid === comment.authorId;
      const canReply = user && !user.isAnonymous;
      
      const commentPath = parentId
        ? `comments/${pageId}/${parentId}/replies/${commentId}`
        : `comments/${pageId}/${commentId}`;
        
      const commentRef = db.ref(commentPath);

      const handleReaction = (reactionType) => {
        if (!user) return;
        
        const oppositeReaction = reactionType === 'likes' ? 'dislikes' : 'likes';
        
        db.ref().update({
          [`${commentPath}/${reactionType}/${user.uid}`]: userHasReacted(reactionType) ? null : true,
          [`${commentPath}/${oppositeReaction}/${user.uid}`]: null
        });
      };
      
      const handleReport = () => {
        if (!user) return;
        const reportRef = commentRef.child(`reports/${user.uid}`);
        reportRef.once('value', snapshot => {
          if (!snapshot.exists()) {
             reportRef.set(true);
          }
        });
        setShowMenu(false);
      };

      const userHasReacted = (type) => user && comment[type] && comment[type][user.uid];

      const likesCount = comment.likes ? Object.keys(comment.likes).length : 0;
      const dislikesCount = comment.dislikes ? Object.keys(comment.dislikes).length : 0;
      
      const userHasLiked = userHasReacted('likes');
      const userHasDisliked = userHasReacted('dislikes');
      const userHasReported = userHasReacted('reports');
      
      const replies = useMemo(() => {
        return comment.replies 
          ? Object.keys(comment.replies).map(key => ({ id: key, ...comment.replies[key] })).sort((a,b) => a.timestamp - b.timestamp)
          : [];
      }, [comment.replies]);

      return (
        <div className="flex space-x-3 py-4">
          <Avatar src={comment.authorPhoto} alt={comment.author} />
          <div className="flex-1">
            <div className="flex items-center space-x-2">
              <span className="font-semibold text-sm text-gray-800 dark:text-disqus-dark-text-primary">{comment.author}</span>
              <span className="text-xs text-gray-500 dark:text-disqus-dark-text-secondary">
                {formatTimeAgo(comment.timestamp)}
              </span>
            </div>
            
            <p className="text-sm mt-1 whitespace-pre-wrap text-gray-900 dark:text-disqus-dark-text-primary">
              {comment.text}
            </p>
            
            <div className="flex items-center space-x-4 mt-2 text-xs font-bold text-gray-500 dark:text-disqus-dark-text-secondary">
              <button
                onClick={() => handleReaction('likes')}
                className="flex items-center space-x-1 hover:opacity-75 transition"
              >
                <LikeIcon liked={userHasLiked} />
                <span>{likesCount > 0 ? likesCount : ''}</span>
              </button>
              
              <button
                onClick={() => handleReaction('dislikes')}
                className="flex items-center space-x-1 hover:opacity-75 transition"
              >
                <DislikeIcon disliked={userHasDisliked} />
                <span>{dislikesCount > 0 ? dislikesCount : ''}</span> 
              </button>
              
              {!parentId && (
                <button
                  disabled={!canReply} // Desabilitado para an√¥nimos
                  onClick={() => setShowReplyForm(!showReplyForm)}
                  className="flex items-center space-x-1 hover:text-gray-900 dark:hover:text-disqus-dark-text-primary disabled:opacity-60 transition"
                >
                  <ReplyIcon />
                  <span>Responder</span>
                </button>
              )}
              
              <div className="relative" onMouseLeave={() => setShowMenu(false)}>
                <button
                  onClick={() => setShowMenu(!showMenu)}
                  className="flex items-center space-x-1 hover:text-gray-900 dark:hover:text-disqus-dark-text-primary transition"
                >
                  <MoreIcon />
                </button>
                
                {showMenu && (
                  <div className="absolute top-6 right-0 w-40 bg-white dark:bg-disqus-dark-card rounded-lg shadow-lg py-1 border border-gray-200 dark:border-disqus-dark-border z-10">
                    <button
                      disabled={!isAuthor} 
                      className="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-disqus-dark-text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50"
                    >
                      Editar
                    </button>
                    <button
                      disabled={userHasReported || !canReply} // An√¥nimos n√£o podem denunciar
                      onClick={handleReport}
                      className="flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-disqus-dark-text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50"
                    >
                      <FlagIcon className="w-4 h-4 mr-2" />
                      {userHasReported ? 'Denunciado' : 'Denunciar'}
                    </button>
                  </div>
                )}
              </div>
              
            </div>
            
            {showReplyForm && canReply && (
              <CommentForm
                user={user}
                pageId={pageId}
                parentId={commentId}
                onCommentPosted={() => setShowReplyForm(false)}
              />
            )}
            
            {replies.length > 0 && (
              <div className="mt-4 pl-4 border-l-2 border-gray-200 dark:border-disqus-dark-border">
                {replies.map(reply => (
                  <Comment
                    key={reply.id}
                    comment={reply}
                    user={user}
                    pageId={pageId}
                    parentId={commentId}
                  />
                ))}
              </div>
            )}
          </div>
        </div>
      );
    });

    // ATUALIZADO: Dropdown de Login (para an√¥nimos)
    const LoginDropdown = ({ user, logout }) => {
      const [isOpen, setIsOpen] = useState(false);
      
      if (!user || user.isAnonymous) {
        return (
          <div className="relative">
             <button className="flex items-center space-x-1 text-sm font-medium text-gray-700 dark:text-disqus-dark-text-secondary hover:text-gray-900 dark:hover:text-disqus-dark-text-primary">
              <span>Entrar</span>
              <ChevronDownIcon />
            </button>
          </div>
        );
      }
      
      return (
        <div className="relative">
          <button onClick={() => setIsOpen(!isOpen)} className="flex items-center space-x-2">
            <Avatar src={user.photoURL} alt={user.displayName} className="w-6 h-6" />
            <ChevronDownIcon />
          </button>
          
          {isOpen && (
            <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-disqus-dark-card rounded-lg shadow-lg py-1 border border-transparent dark:border-disqus-dark-border z-10">
              <div className="px-4 py-2 border-b border-gray-100 dark:border-disqus-dark-border">
                <p className="text-sm font-medium truncate">{user.displayName}</p>
              </div>
              <button
                onClick={() => {
                  logout(); 
                  setIsOpen(false);
                }}
                className="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-disqus-dark-text-secondary hover:bg-gray-100 dark:hover:bg-gray-700"
              >
                Sair
              </button>
            </div>
          )}
        </div>
      );
    };
    
    // ATUALIZADO: Controles da Thread (caminhos corrigidos)
    const ThreadControls = ({ user, pageId, commentCount, sortBy, setSortBy, onLogout }) => {
      const [likes, setLikes] = useState({});
      
      // *** CORRE√á√ÉO: Aponta para 'media_stats' ***
      const basePath = `media_stats/${pageId}`;
      const likesRef = useMemo(() => user ? db.ref(`${basePath}/threadLikes/${user.uid}`) : null, [basePath, user]);
      const likesCountRef = useMemo(() => db.ref(`${basePath}/threadLikes`), [basePath]);
      
      useEffect(() => {
        // Ouve apenas o like do utilizador atual
        if (!likesRef) {
           setLikes({});
           return;
        }
        const listener = likesRef.on('value', snapshot => {
            setLikes(snapshot.exists() ? { [user.uid]: true } : {});
        });
        return () => likesRef.off('value', listener);
      }, [likesRef, user]);

      // Conta o total de likes
      const [likeCount, setLikeCount] = useState(0);
      useEffect(() => {
         const listener = likesCountRef.on('value', snapshot => {
            setLikeCount(snapshot.exists() ? snapshot.numChildren() : 0);
         });
         return () => likesCountRef.off('value', listener);
      }, [likesCountRef]);
      
      const userHasLiked = user && likes[user.uid];
      
      const handleThreadLike = () => {
        if (!likesRef) return; // Prote√ß√£o
        if (userHasLiked) {
          likesRef.remove();
        } else {
          likesRef.set(true);
        }
      };
      
      const SortButton = ({ type, text }) => (
        <button
          onClick={() => setSortBy(type)}
          className={`px-3 py-1.5 text-sm font-medium rounded-lg ${sortBy === type ? 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white' : 'text-gray-500 dark:text-disqus-dark-text-secondary hover:text-gray-900 dark:hover:text-white'}`}
        >
          {text}
        </button>
      );
      
      return (
        <Fragment>
          <div className="flex items-center justify-between mt-4 py-2 border-t border-b border-gray-200 dark:border-disqus-dark-border">
            <div className="flex items-center space-x-4">
              <button
                onClick={handleThreadLike}
                className={`flex items-center space-x-1.5 text-sm font-medium transition ${userHasLiked ? 'text-red-500' : 'text-gray-500 dark:text-disqus-dark-text-secondary hover:text-red-500'}`}
              >
                <HeartIcon />
                <span>{likeCount > 0 ? likeCount : 'Gostar'}</span>
              </button>
              
              <button
                 className="flex items-center space-x-1.5 text-sm font-medium text-gray-500 dark:text-disqus-dark-text-secondary hover:text-gray-900 dark:hover:text-white"
              >
                <ShareIcon />
                <span>Compartilhar</span>
              </button>
            </div>
            
             <LoginDropdown user={user} logout={onLogout} />
          </div>
          
          <div className="flex items-center justify-between my-4">
            <h3 className="text-lg font-semibold text-gray-900 dark:text-disqus-dark-text-primary">
              {commentCount} Coment√°rio{commentCount !== 1 ? 's' : ''}
            </h3>
            <div className="flex items-center space-x-2">
              <SortButton type="best" text="Mais votados" />
              <SortButton type="newest" text="Mais recentes" />
              <SortButton type="oldest" text="Mais antigos" />
            </div>
          </div>
        </Fragment>
      );
    }
    

    // ATUALIZADO: Componente Principal (l√≥gica de renderiza√ß√£o)
    function App() {
      const { user, loading: authLoading, login, logout } = useAuth();
      const pageId = usePageId();
      const [comments, setComments] = useState([]);
      const [commentsLoading, setCommentsLoading] = useState(true);
      const [sortBy, setSortBy] = useState('newest');
      
      useEffect(() => {
        if (!pageId) return; 
        
        setCommentsLoading(true);
        const commentsRef = db.ref(`comments/${pageId}`).orderByChild('timestamp');
        
        const listener = commentsRef.on('value', snapshot => {
          const data = snapshot.val();
          let commentsList = [];
          if (data) {
            commentsList = Object.keys(data)
              .map(key => ({ id: key, ...data[key] }));
          }
          setComments(commentsList);
          setCommentsLoading(false);
        });

        return () => commentsRef.off('value', listener);
      }, [pageId]);
      
      const sortedComments = useMemo(() => {
        const getScore = (c) => {
          const likes = c.likes ? Object.keys(c.likes).length : 0;
          const dislikes = c.dislikes ? Object.keys(c.dislikes).length : 0;
          return likes - dislikes;
        };
        
        switch (sortBy) {
          case 'oldest':
            return [...comments];
          case 'best':
            return [...comments].sort((a, b) => getScore(b) - getScore(a));
          case 'newest':
          default:
            return [...comments].reverse();
        }
      }, [comments, sortBy]);
      
      if (authLoading || !pageId) {
        return (
          <div className="flex items-center justify-center h-full p-6">
            <Spinner />
          </div>
        );
      }
      
      const isRealUser = user && !user.isAnonymous;
      
      return (
        <div className="p-4 md:p-6 max-w-3xl mx-auto">
          
          <ReactionsBar pageId={pageId} user={user} />
          
          <hr className="border-gray-200 dark:border-disqus-dark-border my-6" />

          {/* √Årea do Formul√°rio Principal */}
          {isRealUser ? (
            <CommentForm user={user} pageId={pageId} />
          ) : (
            <Fragment>
              <LoggedOutCommentForm />
              <LoginForm login={login} />
            </Fragment>
          )}

          <ThreadControls
            user={user}
            onLogout={logout}
            pageId={pageId}
            commentCount={sortedComments.length}
            sortBy={sortBy}
            setSortBy={setSortBy}
          />

          {commentsLoading && sortedComments.length === 0 && (
             <div className="flex items-center justify-center h-24">
                <Spinner />
             </div>
          )}
          
          <div className="divide-y divide-gray-200 dark:divide-disqus-dark-border">
            {!commentsLoading && sortedComments.length === 0 ? (
              <p className="text-sm text-center text-gray-500 dark:text-disqus-dark-text-secondary py-10">
                Seja o primeiro a comentar.
              </p>
            ) : (
              sortedComments.map(comment => (
                <Comment
                  key={comment.id}
                  comment={comment}
                  user={user}
                  pageId={pageId}
                />
              ))
            )}
          </div>
        </div>
      );
    }
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>
